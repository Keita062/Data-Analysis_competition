# 課題の内容
あらすじ文から元となった作品を予測していただきます。
与えられるのは、LLM（大規模言語モデル）によって生成された「架空作品のあらすじ」。 

# データの概要
- ```base_stories.tsv```
    - 本コンペティションで利用している元ネタの作品名とあらすじが記載されています。作品名に対応するラベルが、その作品のラベルとなります。
        - columns
            - 'id', 
            - 'category', 
            - 'title', 
            - 'story'

- ```fiction_stories_practice.tsv```
    - 本コンペティションの練習用データです。このデータの予測結果は提出する必要はございません。本課題を理解するためのデータとしてご利用ください。
        - columns
            - 'id_a'
            - 'id_b'
            - 'title_a'
            - 'title_b'
            - 'story'

- ```fiction_stories_test.tsv```
    - 架空の作品340作品のidと本文が入った評価用データです。こちらの内容をもとに作品を予測していただきます。
        - columns
            - 'id', 
            - 'story'

- ```sample_submit.csv```
    - 投稿ファイルのサンプルです。aとbに予測した映画のid(```base_stories.csv```のラベル)を入れてください。

# 分析方針
1. EDA
    1. キーワード残存・変容分析
        
         - ``` base_stories```のあらすじを形態素解析（MeCab等）し、名詞・固有名詞を抽出します。

            practiceの文章の中に、それらの単語が「そのまま」含まれているか、あるいは「類義語」に変換されているかをスコアリング。

    2. 物語の接合部の判定プロセスの構築

        - 合成あらすじを「文（Sentence）」単位に分割します。

            - 各文が、base_storiesの50作品のどれと最も類似しているかを、TF-IDFや文ベクトルで計算します。

            - これにより、検索時に「全文」で検索すべきか「分割して」検索すべきかの戦略が決まります。


    3. カテゴリの論理的関連性の精査

        - practiceのあらすじから、LLMに「推定されるカテゴリ」を抽出させます。

            - base_storiesのcategory（洋画、アニメ等）との一致率を調べます。

        - 詳細確認の意味: 単なる「アニメか実写か」の区別だけでなく、「SF」「サスペンス」といった属性が合成後も保持されているかを分析し、検索エンジンのスコアに加点（ブースト）を与える変数として利用します。

2. ハイブリッド検索エンジンの構築

    1. キーワード検索の実装 (BM25)
        - 手法: 
            - rank_bm25ライブラリを使用。

        - 詳細: 
            - あらすじを単語単位（トークン）に分解し、「その作品に特有の珍しい単語」が一致したときに高いスコアを与えます。

        - 効果: 
            - 固有名詞や特殊な設定語が残っている場合に、一撃で正解を引き当てます。
    
    2. 意味検索の実装 (ベクトル検索)
        - 手法: 
            - sentence-transformersを用い、intfloat/multilingual-e5-base等のモデルで文章をベクトル化します。

        - 詳細: 
            - 全文ベクトルだけでなく、「冒頭のみ」「末尾のみ」のベクトルも作成し、合成あらすじの部分的な一致も拾えるようにします。

        - 効果: 
            - 言い換え（例：「宇宙船」→「銀河を渡る器」）によるキーワード漏れを補完します。
 
    3. ハイブリッド統合 (RRF)
        - 手法: 
            - Reciprocal Rank Fusion (RRF) を採用します。

        - 詳細: 
            - $Score(d) = \sum_{r \in \{BM25, Vector\}} \frac{1}{60 + Rank_r(d)}$

        - 効果: 
            - 異なる性質の検索結果（単語一致と意味一致）を、単純なスコア加算ではなく「順位」で統合することで、両方で上位に来た「真に怪しい作品」を確実に抽出できます。

3. LLMによる決定論的リランキング
    1. 決定論的設計（再現性の確保）
        - 「回すたびに結果が変わる」ことを防ぐため、以下の設定を厳守します。
        - Temperature = 0: 常に最も確率の高いトークンを選択させます。
        - Seedの固定: 乱数シードを指定し、計算のゆらぎを排除します。
        - JSON Mode: 出力を {"id_a": X, "id_b": Y} の形式に強制し、解析エラーを防ぎます。
    2. プロンプトエンジニアリング
        -  プロンプト内で「まず共通点を書き出し、次に矛盾点を探し、最後にIDを選べ」というステップを明示します。

        - 「選んだ2つの作品の要素が、架空のあらすじのどこに対応するか説明せよ」と指示することで、LLMのハルシネーション（嘘）を抑制します。

4. 正解率の算出と最終提出
    1. 評価 (Validation): 練習用データ20件に対し、作成したシステムを実行。

    2. （上位10件に正解の2つが入っているか）と（最終的な2つのIDが正解と一致するか）を算出。

    3. テスト実行: test.tsvの340件に対し、上記フローを一括適用。

    4. フォーマット整形: 予測した2つのIDを昇順(小さい順)に並べ替え。

    5. sample_submit.csvの形式（ID, Pred1, Pred2）に流し込み、CSVとして出力。

# 現状分析
1. 環境構築とライブラリの読み込み
- 形態素解析エンジン「MeCab」や、ベクトル検索のための「Sentence-Transformers」、伝統的な全文検索アルゴリズム「BM25」などの必要なライブラリをインストールし、インポートしています。

2. データの読み込みと前処理
- データのロード: 元ネタとなる50件の物語（base_stories.tsv）と、練習用データ、テスト用データを読み込んでいます。

- 特徴抽出: MeCabを使用して、各物語から「名詞（一般・固有名詞・サ変接続）」のみを抽出する関数を作成し、キーワードリストを作成しています。

3. 特徴語の残存率分析（現状把握）
- 合成された物語の中に、元の物語のキーワードがどの程度残っているかを算出しています。

- TF-IDFを用いて、その作品を象徴する「レアな単語」がどの程度生存しているかを分析し、検索のヒントを探っています。

- 物語の文ごとに類似度をプロットし、文章のどの位置にどの作品の要素が現れるか（Story Flow）を可視化しました。

4. ハイブリッド検索エンジンの構築
- BM25（単語ベース）とE5モデル（ベクトルベース）の2種類を組み合わせた検索システムを実装しました。

- スライディングウィンドウ法: 物語全体を一気に検索するのではなく、2文ずつの「窓」に区切って検索を行い、どこかに強い反応があれば拾い上げる工夫をしています。

- RRF (Reciprocal Rank Fusion): 複数の検索手法の結果を統合し、最終的なランキングを決定しています。

5. 精度検証（評価）
- 練習用データ（20件）を用いて、構築したシステムの性能をテストしました。

- Recall@10: 上位10位以内に正解が含まれる確率は 85%。

- Perfect Match Accuracy: 上位2件がピタリと正解（2作品とも的中）した確率は 30% という結果が出ています。

6. テストデータへの予測と提出ファイル作成
- 学習や検証に使っていない本番用データ（340件）に対して予測を実行しました。

- 予測された2つの作品IDを昇順に並べ替え、指定されたCSV形式（submission.csv）で出力して終了しています。
